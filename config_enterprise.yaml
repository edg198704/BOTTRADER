# Main Configuration for the Enterprise Trading Bot

initial_capital: 10000.0

exchange:
  # For real exchanges, API key and secret MUST be set via environment variables:
  # BOT_EXCHANGE_API_KEY="your_key"
  # BOT_EXCHANGE_API_SECRET="your_secret"
  name: "MockExchange"  # Exchange name (e.g., 'binance', 'bybit'). Use 'MockExchange' for testing.
  testnet: true         # Use the exchange's testnet/sandbox environment
  retry:
    max_attempts: 3
    delay_seconds: 2    # Initial delay for retries
    backoff_factor: 2   # Multiplier for subsequent delays (e.g., 2s, 4s, 8s)

execution:
  default_order_type: "LIMIT" # Can be 'MARKET' or 'LIMIT'. LIMIT is recommended to reduce slippage.
  limit_price_offset_pct: 0.0005 # 0.05% offset from current price for placing limit orders.
  order_fill_timeout_seconds: 45 # How long to wait for a fill before cancelling.

  # --- Active Order Management (Order Chasing) ---
  # For LIMIT orders, this feature will actively try to get a fill if the market moves.
  use_order_chasing: true
  # How long to wait before checking if the order needs to be moved closer to the market price.
  chase_interval_seconds: 5
  # How many times to cancel and replace the order before giving up.
  max_chase_attempts: 3
  # How much more aggressive to make the price on each chase (e.g., 0.0002 is 0.02%).
  chase_aggressiveness_pct: 0.0002
  # If the order is still not filled after all chase attempts, place a MARKET order to guarantee execution.
  # WARNING: This can lead to significant slippage. Use with caution.
  execute_on_timeout: false

data_handler:
  history_limit: 200 # Number of historical candles to load at startup
  update_interval_multiplier: 0.5 # Update data every (strategy.interval_seconds * 0.5) seconds

strategy:
  symbols: ["BTC/USDT", "ETH/USDT"] # List of symbols to trade
  interval_seconds: 10      # Time in seconds between each trading cycle check.
  timeframe: "5m"           # Timeframe for OHLCV data (e.g., '1m', '5m', '1h', '1d')

  # This section now drives all technical indicator calculations in a modular way.
  # Each item is passed to the pandas-ta library.
  indicators:
    - kind: "rsi"
      length: 14
      # Default alias is 'rsi' (generated by utils.py if not specified), but explicit is better
      alias: "rsi"
    - kind: "macd"
      fast: 12
      slow: 26
      signal: 9
    - kind: "bbands"
      length: 20
      std: 2
    - kind: "atr"
      length: 14
      alias: "atr"
    - kind: "adx"
      length: 14
    - kind: "sma"
      length: 10
      alias: "sma_fast"
    - kind: "sma"
      length: 20
      alias: "sma_slow"

  # The 'params' block now contains the strategy name and its specific parameters.
  # Pydantic uses the 'name' field to validate the rest of the parameters
  # against the correct strategy model from config.py.
  params:
    name: "AIEnsembleStrategy" # Strategy to use. MUST match a strategy class name.

    # --- Settings for AIEnsembleStrategy ---
    # The feature_columns must be a subset of the base columns (open, high, low, close, volume)
    # or the columns generated by the 'indicators' list above.
    # The bot will validate this on startup.
    feature_columns: ['close', 'rsi', 'macd', 'volume', 'bb_upper', 'bb_lower']
    confidence_threshold: 0.65
    model_path: "models/ensemble"
    use_regime_filter: true
    retrain_interval_hours: 24
    training_data_limit: 5000 # How many candles to fetch for retraining

    # --- Feature Engineering Parameters ---
    features:
      sequence_length: 30 # Lookback window for sequential models like LSTM/Attention
      labeling_horizon: 5 # How many candles into the future to look for labeling
      labeling_threshold: 0.005 # % price change to define a buy/sell label (Fallback if dynamic is off)
      normalization_window: 100 # Rolling window for Z-score normalization
      # Dynamic Labeling: Uses ATR to adjust threshold based on volatility
      use_dynamic_labeling: true
      labeling_atr_multiplier: 1.0 # Threshold = ATR * 1.0

    # --- Model Training Parameters ---
    training:
      epochs: 50 # Max epochs to train for
      batch_size: 64
      learning_rate: 0.001
      early_stopping_patience: 5 # Stop training if validation loss doesn't improve for this many epochs
      validation_split: 0.15 # Percentage of training data to use for validation
      min_precision_threshold: 0.55 # Require at least 55% precision on validation set to accept new model

    # --- Model Hyperparameters ---
    hyperparameters:
      xgboost:
        n_estimators: 100
        max_depth: 3
        learning_rate: 0.1
        subsample: 0.8
        colsample_bytree: 0.8
      random_forest:
        n_estimators: 100
        max_depth: 10
        min_samples_leaf: 5
      logistic_regression:
        max_iter: 1000
        C: 1.0
      lstm:
        hidden_dim: 64
        num_layers: 2
        dropout: 0.2
      attention:
        hidden_dim: 64
        num_layers: 2
        nhead: 4
        dropout: 0.2

    # --- Ensemble Configuration ---
    ensemble_weights:
      xgboost: 0.3
      technical_ensemble: 0.3
      lstm: 0.2
      attention: 0.2

    # --- Market Regime Detector ---
    market_regime:
      trend_strength_threshold: 0.015 # e.g., 1.5% difference between SMAs
      volatility_multiplier: 1.5 # How much higher current volatility must be than average to be 'volatile'
      # Map these to the aliases defined in 'indicators' above
      trend_fast_ma_col: "sma_fast"
      trend_slow_ma_col: "sma_slow"
      volatility_col: "atr"
      rsi_col: "rsi"

# --- Example for SimpleMACrossoverStrategy (for reference) ---
# strategy:
#   symbols: ["BTC/USDT"]
#   interval_seconds: 60
#   timeframe: "1h"
#   indicators:
#     - kind: "sma"
#       length: 10
#       alias: "sma_fast"
#     - kind: "sma"
#       length: 20
#       alias: "sma_slow"
#   params:
#     name: "SimpleMACrossoverStrategy"
#     fast_ma_period: 10
#     slow_ma_period: 20

risk_management:
  max_position_size_usd: 1000.0
  max_daily_loss_usd: 500.0
  max_open_positions: 5 # Increased to allow for multi-symbol trading
  circuit_breaker_threshold: -0.10 # Halt trading if portfolio drops 10%
  use_trailing_stop: true
  atr_stop_multiplier: 2.0
  stop_loss_fallback_pct: 0.05
  risk_per_trade_pct: 0.01
  reward_to_risk_ratio: 1.5
  trailing_stop_activation_pct: 0.02 # Activate TSL after 2% profit
  trailing_stop_pct: 0.01 # Trail by 1% of peak price

  regime_based_risk:
    # Override default risk parameters based on the detected market regime.
    # If a parameter is not set here, the default value above will be used.
    bull:
      risk_per_trade_pct: 0.015 # Take slightly more risk in a clear bull trend
      atr_stop_multiplier: 2.5   # Allow more room for pullbacks
    bear:
      reward_to_risk_ratio: 2.0  # Demand higher reward for shorting
    volatile:
      risk_per_trade_pct: 0.005 # Reduce position size significantly
      atr_stop_multiplier: 3.0   # Use wider stops to avoid getting shaken out
    sideways:
      # No overrides, will use default risk parameters.
      # Could also set risk_per_trade_pct to 0 to avoid trading.

  time_based_exit:
    enabled: false
    max_hold_time_hours: 24
    threshold_pct: 0.005 # Close if PnL < 0.5% after 24 hours

database:
  path: "position_ledger.db"

telegram:
  # The bot token MUST be set via the environment variable:
  # BOT_TELEGRAM_BOT_TOKEN="your_token"
  admin_chat_ids:
    - 123456789 # Replace with your Telegram admin chat ID

logging:
  level: "INFO"
  file_path: "logs/trading_bot.log"
  use_json: false
